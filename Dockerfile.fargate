# [NOTE] ã“ã®Dockerfileã¯ AWS Fargate ä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ Redshift Serverless ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å‰æã«æ§‹æˆ
# - OS: Linux (X86_64)
# - å¿…ãš `python3` + `psycopg2` + `boto3` ã‚’å«ã‚€
# - redshift-serverless ã«æ¥ç¶šã™ã‚‹å ´åˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã«æ³¨æ„ï¼ˆTCP:5439ï¼‰

# - ãƒˆãƒ©ãƒ–ãƒ«ä¾‹: Fargate ã‹ã‚‰ Redshift ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
#   åŸå› : Redshift å´ SG ã« Fargate ã® SG or CIDR è¨±å¯ãŒãªã‹ã£ãŸ


# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯è»½é‡Python
FROM python:3.11-slim

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆpsycopg2ç”¨ã«libpqãŒå¿…è¦ï¼‰
RUN apt-get update && apt-get install -y gcc libpq-dev

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . /app

# å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆRedshift + dotenvï¼‰
RUN pip install --no-cache-dir \
    psycopg2-binary \
    sqlalchemy \
    python-dotenv

# èµ·å‹•æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆechoã¨sleepã§ãƒ­ã‚°è¿½è·¡ã—ã‚„ã™ãï¼‰
CMD ["sh", "-c", "echo 'ğŸ” Starting Fargate task...' && ls -l /app/scripts && cat /app/scripts/etl_copy_redshift.py && python scripts/etl_copy_redshift.py && echo 'âœ… Task finished'"]

